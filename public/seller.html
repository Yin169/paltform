<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卖家中心 - 电商交易平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --white: #ffffff;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
            padding: 1rem;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            width: 250px;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            height: fit-content;
        }

        .sidebar-item {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            background: var(--light-color);
            text-align: left;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
        }

        .content-area {
            flex: 1;
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-weight: 500;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
        }

        .search-bar input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .search-bar input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .search-bar button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-bar button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
        }

        tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: var(--gray);
            font-style: italic;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: var(--white);
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: var(--white);
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #e1156c;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .close {
            cursor: pointer;
            font-size: 1.8rem;
            color: var(--gray);
            transition: var(--transition);
        }

        .close:hover {
            color: var(--danger-color);
        }

        form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-group input, 
        .form-group textarea,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-group input:focus, 
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .required::after {
            content: " *";
            color: var(--danger-color);
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }

        .price {
            font-weight: 600;
            color: #28a745;
        }

        .stock-low {
            color: var(--danger-color);
            font-weight: 600;
        }

        .stock-normal {
            color: #28a745;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-col {
            flex: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: var(--white);
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: var(--danger-color);
        }

        /* Profile Details */
        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .profile-card {
            background-color: #f8f9fc;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--box-shadow);
        }

        .profile-card h4 {
            margin-top: 0;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-item {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
        }

        .profile-label {
            font-weight: 600;
            color: var(--dark-color);
            min-width: 120px;
        }

        .profile-value {
            flex: 1;
        }

        .table-container {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-store"></i> 卖家中心
            </div>
            <div class="user-info">
                <span id="seller-name">卖家</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="sidebar">
                <button class="sidebar-item active" onclick="switchTab('dashboard')">
                    <i class="fas fa-chart-bar"></i> 仪表盘
                </button>
                <button class="sidebar-item" onclick="switchTab('products')">
                    <i class="fas fa-box"></i> 商品管理
                </button>
                <button class="sidebar-item" onclick="switchTab('orders')">
                    <i class="fas fa-shopping-cart"></i> 订单管理
                </button>
                <button class="sidebar-item" onclick="switchTab('customer-profiles')">
                    <i class="fas fa-user-circle"></i> 客户画像
                </button>
                <button class="sidebar-item" onclick="switchTab('product-profiles')">
                    <i class="fas fa-chart-bar"></i> 商品画像
                </button>
                <button class="sidebar-item" onclick="switchTab('add-product')">
                    <i class="fas fa-plus"></i> 添加商品
                </button>
            </div>

            <div class="content-area">
                <!-- 仪表盘 -->
                <div id="dashboard" class="tab-content active">
                    <h2><i class="fas fa-chart-bar"></i> 仪表盘</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-value" id="product-count">0</div>
                            <div class="stat-label">商品数量</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-value" id="order-count">0</div>
                            <div class="stat-label">订单总数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-yen-sign"></i>
                            </div>
                            <div class="stat-value" id="total-sales">¥0.00</div>
                            <div class="stat-label">总销售额</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="customer-count">0</div>
                            <div class="stat-label">客户数量</div>
                        </div>
                    </div>
                </div>

                <!-- 商品管理 -->
                <div id="products" class="tab-content">
                    <h2><i class="fas fa-box"></i> 商品管理</h2>
                    <div class="search-bar">
                        <input type="text" id="product-search" placeholder="按商品名称或分类搜索...">
                        <button onclick="searchProducts()"><i class="fas fa-search"></i> 搜索</button>
                        <button class="btn btn-success" onclick="switchTab('add-product')">
                            <i class="fas fa-plus"></i> 添加商品
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>商品信息</th>
                                    <th>价格</th>
                                    <th>库存</th>
                                    <th>分类</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <tr>
                                    <td colspan="5" class="no-data">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 订单管理 -->
                <div id="orders" class="tab-content">
                    <h2><i class="fas fa-shopping-cart"></i> 订单管理</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>订单号</th>
                                    <th>客户</th>
                                    <th>商品</th>
                                    <th>总金额</th>
                                    <th>下单时间</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <tr>
                                    <td colspan="5" class="no-data">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 客户画像 -->
                <div id="customer-profiles" class="tab-content">
                    <h2><i class="fas fa-user-circle"></i> 客户画像分析</h2>
                    <div class="search-bar">
                        <input type="text" id="customer-profile-search" placeholder="搜索客户画像...">
                        <button onclick="searchCustomerProfiles()"><i class="fas fa-search"></i> 搜索</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>客户</th>
                                    <th>价值评分</th>
                                    <th>生命周期</th>
                                    <th>总消费</th>
                                    <th>购买次数</th>
                                    <th>偏好类别</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="customer-profiles-table-body">
                                <tr>
                                    <td colspan="7" class="no-data">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 商品画像 -->
                <div id="product-profiles" class="tab-content">
                    <h2><i class="fas fa-chart-bar"></i> 商品画像分析</h2>
                    <div class="search-bar">
                        <input type="text" id="seller-product-profile-search" placeholder="搜索商品画像...">
                        <button onclick="searchProductProfiles()"><i class="fas fa-search"></i> 搜索</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>商品</th>
                                    <th>受欢迎度</th>
                                    <th>生命周期</th>
                                    <th>总销量</th>
                                    <th>平均月销量</th>
                                    <th>转化率</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="product-profiles-table-body">
                                <tr>
                                    <td colspan="7" class="no-data">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 添加商品 -->
                <div id="add-product" class="tab-content">
                    <h2><i class="fas fa-plus"></i> 添加商品</h2>
                    <form id="product-form">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="product-name" class="required">商品名称</label>
                                    <input type="text" id="product-name" required placeholder="请输入商品名称">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="product-category" class="required">分类</label>
                                    <select id="product-category" required>
                                        <option value="">请选择分类</option>
                                        <option value="电子产品">电子产品</option>
                                        <option value="服装">服装</option>
                                        <option value="家居">家居</option>
                                        <option value="图书">图书</option>
                                        <option value="食品">食品</option>
                                        <option value="美妆">美妆</option>
                                        <option value="运动">运动</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-description" class="required">商品描述</label>
                            <textarea id="product-description" rows="4" placeholder="请输入商品详细描述"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="product-price" class="required">价格 (¥)</label>
                                    <input type="number" id="product-price" step="0.01" min="0" required placeholder="请输入商品价格">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="product-quantity" class="required">库存</label>
                                    <input type="number" id="product-quantity" min="0" required placeholder="请输入库存数量">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-image">图片链接</label>
                            <input type="text" id="product-image" placeholder="请输入商品图片链接">
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-info" onclick="switchTab('products')">
                                <i class="fas fa-arrow-left"></i> 返回商品列表
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> 添加商品
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 商品详情/编辑模态框 -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">编辑商品</h3>
                <span class="close" onclick="document.getElementById('product-modal').style.display='none'">&times;</span>
            </div>
            <form id="edit-product-form">
                <input type="hidden" id="edit-product-id">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="edit-product-name" class="required">商品名称</label>
                            <input type="text" id="edit-product-name" required placeholder="请输入商品名称">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="edit-product-category" class="required">分类</label>
                            <select id="edit-product-category" required>
                                <option value="">请选择分类</option>
                                <option value="电子产品">电子产品</option>
                                <option value="服装">服装</option>
                                <option value="家居">家居</option>
                                <option value="图书">图书</option>
                                <option value="食品">食品</option>
                                <option value="美妆">美妆</option>
                                <option value="运动">运动</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-product-description" class="required">商品描述</label>
                    <textarea id="edit-product-description" rows="4" placeholder="请输入商品详细描述"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="edit-product-price" class="required">价格 (¥)</label>
                            <input type="number" id="edit-product-price" step="0.01" min="0" required placeholder="请输入商品价格">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="edit-product-quantity" class="required">库存</label>
                            <input type="number" id="edit-product-quantity" min="0" required placeholder="请输入库存数量">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-product-image">图片链接</label>
                    <input type="text" id="edit-product-image" placeholder="请输入商品图片链接">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-info" onclick="document.getElementById('product-modal').style.display='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> 保存更改
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 客户画像详情模态框 -->
    <div id="customer-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">客户画像详情</h3>
                <span class="close" onclick="document.getElementById('customer-profile-modal').style.display='none'">&times;</span>
            </div>
            <div id="customer-profile-details">
                <!-- 客户画像详情将通过JavaScript动态加载 -->
            </div>
        </div>
    </div>

    <!-- 商品画像详情模态框 -->
    <div id="seller-product-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">商品画像详情</h3>
                <span class="close" onclick="document.getElementById('seller-product-profile-modal').style.display='none'">&times;</span>
            </div>
            <div id="seller-product-profile-details">
                <!-- 商品画像详情将通过JavaScript动态加载 -->
            </div>
        </div>
    </div>

    <!-- 通知消息 -->
    <div id="notification" class="notification"></div>

    <script>
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            loadUserInfo();
            loadDashboard();
        });

        // 显示通知
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 登出
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // 加载用户信息
        async function loadUserInfo() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('seller-name').textContent = user.username;
                    
                    // 检查用户角色，如果不是卖家或管理员则跳转到首页
                    if (user.role !== 'seller' && user.role !== 'admin') {
                        showNotification('您没有卖家权限', 'error');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                        return;
                    }
                } else {
                    // Token无效，跳转到登录页
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('加载用户信息失败:', error);
                window.location.href = '/login.html';
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有侧边栏项目的活动状态
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            
            // 设置选中侧边栏项目为活动状态
            event.target.closest('.sidebar-item').classList.add('active');
            
            // 根据选中的标签加载数据
            if (tabName === 'products') {
                loadProducts();
            } else if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'customer-profiles') {
                loadCustomerProfiles();
            } else if (tabName === 'product-profiles') {
                loadSellerProductProfiles();
            } else if (tabName === 'add-product') {
                // 清空表单
                document.getElementById('product-form').reset();
            }
        }

        // 加载仪表盘数据
        async function loadDashboard() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/seller/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('product-count').textContent = stats.productCount;
                    document.getElementById('order-count').textContent = stats.totalOrders;
                    document.getElementById('total-sales').textContent = `¥${stats.totalSales.toFixed(2)}`;
                    document.getElementById('customer-count').textContent = stats.customerCount || 0;
                } else {
                    const error = await response.json();
                    showNotification('加载仪表盘数据失败: ' + (error.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
                showNotification('加载仪表盘数据失败: ' + error.message, 'error');
            }
        }

        // 搜索商品
        async function searchProducts() {
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            const token = localStorage.getItem('token');
            
            if (!searchTerm) {
                loadProducts();
                return;
            }
            
            try {
                const response = await fetch('/api/seller/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const products = await response.json();
                    const filteredProducts = products.filter(product => 
                        product.name.toLowerCase().includes(searchTerm) || 
                        (product.category && product.category.toLowerCase().includes(searchTerm))
                    );
                    displayProducts(filteredProducts);
                } else {
                    const error = await response.json();
                    document.getElementById('products-table-body').innerHTML = 
                        '<tr><td colspan="5" class="no-data">搜索失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('搜索商品失败:', error);
                document.getElementById('products-table-body').innerHTML = 
                    '<tr><td colspan="5" class="no-data">搜索失败: ' + error.message + '</td></tr>';
            }
        }

        // 加载商品数据
        async function loadProducts() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/seller/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const products = await response.json();
                    displayProducts(products);
                } else {
                    const error = await response.json();
                    document.getElementById('products-table-body').innerHTML = 
                        '<tr><td colspan="5" class="no-data">加载商品失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('加载商品失败:', error);
                document.getElementById('products-table-body').innerHTML = 
                    '<tr><td colspan="5" class="no-data">加载商品失败: ' + error.message + '</td></tr>';
            }
        }

        // 显示商品数据
        function displayProducts(products) {
            const tbody = document.getElementById('products-table-body');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">暂无商品</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${product.imageUrl ? 
                                `<img src="${product.imageUrl}" alt="${product.name}" class="product-image">` : 
                                `<div class="product-image" style="background: ${getRandomColor()}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${product.name.charAt(0)}
                                </div>`
                            }
                            <div>
                                <div style="font-weight: 600;">${product.name}</div>
                                <div style="font-size: 14px; color: #666;">ID: ${product._id.substring(0, 8)}...</div>
                            </div>
                        </div>
                    </td>
                    <td class="price">¥${product.price.toFixed(2)}</td>
                    <td class="${product.quantity < 10 ? 'stock-low' : 'stock-normal'}">
                        ${product.quantity} ${product.quantity < 10 ? '(库存不足)' : ''}
                    </td>
                    <td>${product.category || '未分类'}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="editProduct('${product._id}')">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product._id}')">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 生成随机颜色用于商品图片占位符
        function getRandomColor() {
            const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#f8961e'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // 编辑商品
        async function editProduct(productId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const product = await response.json();
                    showEditProductForm(product);
                } else {
                    const error = await response.json();
                    showNotification('加载商品详情失败: ' + (error.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载商品详情失败:', error);
                showNotification('加载商品详情失败: ' + error.message, 'error');
            }
        }

        // 显示编辑商品表单
        function showEditProductForm(product) {
            document.getElementById('edit-product-id').value = product._id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-description').value = product.description || '';
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-quantity').value = product.quantity;
            document.getElementById('edit-product-category').value = product.category || '';
            document.getElementById('edit-product-image').value = product.imageUrl || '';
            
            document.getElementById('product-modal').style.display = 'block';
        }

        // 删除商品
        async function deleteProduct(productId) {
            if (!confirm('确定要删除这个商品吗？此操作不可恢复！')) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('商品删除成功', 'success');
                    loadProducts();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showNotification('删除失败: ' + (error.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('删除商品失败:', error);
                showNotification('删除商品失败: ' + error.message, 'error');
            }
        }

        // 加载订单数据
        async function loadOrders() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/seller/orders', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const orders = await response.json();
                    displayOrders(orders);
                } else {
                    const error = await response.json();
                    document.getElementById('orders-table-body').innerHTML = 
                        '<tr><td colspan="5" class="no-data">加载订单失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('加载订单失败:', error);
                document.getElementById('orders-table-body').innerHTML = 
                    '<tr><td colspan="5" class="no-data">加载订单失败: ' + error.message + '</td></tr>';
            }
        }

        // 显示订单数据
        function displayOrders(orders) {
            const tbody = document.getElementById('orders-table-body');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">暂无订单</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const productNames = order.items.map(item => item.product.name).join(', ');
                const totalAmount = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${order._id.substring(0, 8)}...</div>
                            <div style="font-size: 12px; color: #666;">${order.status || '待处理'}</div>
                        </td>
                        <td>
                            <div>${order.user.username}</div>
                            <div style="font-size: 12px; color: #666;">${order.user.email}</div>
                        </td>
                        <td>
                            <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${productNames}">
                                ${productNames}
                            </div>
                        </td>
                        <td class="price">¥${totalAmount.toFixed(2)}</td>
                        <td>${new Date(order.createdAt).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // 加载客户画像数据
        async function loadCustomerProfiles() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/seller/customer-profiles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profiles = await response.json();
                    displayCustomerProfiles(profiles);
                } else {
                    const error = await response.json();
                    document.getElementById('customer-profiles-table-body').innerHTML = 
                        '<tr><td colspan="7" class="no-data">加载客户画像失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('加载客户画像失败:', error);
                document.getElementById('customer-profiles-table-body').innerHTML = 
                    '<tr><td colspan="7" class="no-data">加载客户画像失败: ' + error.message + '</td></tr>';
            }
        }

        // 显示客户画像数据
        function displayCustomerProfiles(profiles) {
            const tbody = document.getElementById('customer-profiles-table-body');
            
            if (profiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">暂无客户画像</td></tr>';
                return;
            }
            
            tbody.innerHTML = profiles.map(profile => `
                <tr>
                    <td>${profile.user.username}</td>
                    <td>${profile.valueScore || 0}/100</td>
                    <td><span class="status-badge status-${profile.lifecycleStage || 'new'}">${getLifecycleStageText(profile.lifecycleStage || 'new')}</span></td>
                    <td>¥${(profile.behavior?.totalSpent || 0).toFixed(2)}</td>
                    <td>${profile.behavior?.purchaseFrequency || 0}</td>
                    <td>${(profile.behavior?.preferredCategories || []).join(', ') || '无'}</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewCustomerProfile('${profile.user._id}')"><i class="fas fa-chart-pie"></i> 详情</button>
                    </td>
                </tr>
            `).join('');
        }

        // 搜索客户画像
        async function searchCustomerProfiles() {
            const searchTerm = document.getElementById('customer-profile-search').value.toLowerCase();
            const token = localStorage.getItem('token');
            
            if (!searchTerm) {
                loadCustomerProfiles();
                return;
            }
            
            try {
                const response = await fetch('/api/seller/customer-profiles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profiles = await response.json();
                    const filteredProfiles = profiles.filter(profile => 
                        profile.user.username.toLowerCase().includes(searchTerm)
                    );
                    displayCustomerProfiles(filteredProfiles);
                } else {
                    const error = await response.json();
                    document.getElementById('customer-profiles-table-body').innerHTML = 
                        '<tr><td colspan="7" class="no-data">搜索失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('搜索客户画像失败:', error);
                document.getElementById('customer-profiles-table-body').innerHTML = 
                    '<tr><td colspan="7" class="no-data">搜索失败: ' + error.message + '</td></tr>';
            }
        }

        // 查看客户画像详情
        async function viewCustomerProfile(userId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/seller/customer-profiles/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    showCustomerProfileDetails(profile);
                } else {
                    const error = await response.json();
                    showNotification('加载客户画像详情失败: ' + (error.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载客户画像详情失败:', error);
                showNotification('加载客户画像详情失败: ' + error.message, 'error');
            }
        }

        // 显示客户画像详情
        function showCustomerProfileDetails(profile) {
            const modal = document.getElementById('customer-profile-modal');
            const details = document.getElementById('customer-profile-details');
            
            details.innerHTML = `
                <div class="profile-details">
                    <div class="profile-card">
                        <h4><i class="fas fa-user"></i> 基本信息</h4>
                        <div class="profile-item">
                            <span class="profile-label">用户名:</span>
                            <span class="profile-value">${profile.user.username}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">邮箱:</span>
                            <span class="profile-value">${profile.user.email}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">价值评分:</span>
                            <span class="profile-value">${profile.valueScore || 0}/100</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">生命周期阶段:</span>
                            <span class="profile-value"><span class="status-badge status-${profile.lifecycleStage || 'new'}">${getLifecycleStageText(profile.lifecycleStage || 'new')}</span></span>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h4><i class="fas fa-chart-line"></i> 消费行为</h4>
                        <div class="profile-item">
                            <span class="profile-label">总消费金额:</span>
                            <span class="profile-value">¥${(profile.behavior?.totalSpent || 0).toFixed(2)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">购买次数:</span>
                            <span class="profile-value">${profile.behavior?.purchaseFrequency || 0}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">平均订单价值:</span>
                            <span class="profile-value">¥${(profile.behavior?.avgOrderValue || 0).toFixed(2)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">购物车放弃率:</span>
                            <span class="profile-value">${profile.behavior?.cartAbandonmentRate ? (profile.behavior.cartAbandonmentRate * 100).toFixed(0) : 0}%</span>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h4><i class="fas fa-heart"></i> 偏好分析</h4>
                        <div class="profile-item">
                            <span class="profile-label">偏好类别:</span>
                            <span class="profile-value">${(profile.behavior?.preferredCategories || []).join(', ') || '暂无数据'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // 获取生命周期阶段文本
        function getLifecycleStageText(stage) {
            const stageMap = {
                'new': '新用户',
                'active': '活跃用户',
                'at_risk': '流失风险',
                'churned': '已流失',
                'vip': 'VIP用户'
            };
            return stageMap[stage] || stage;
        }

        // 加载商品画像数据
        async function loadSellerProductProfiles() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/seller/product-profiles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profiles = await response.json();
                    displaySellerProductProfiles(profiles);
                } else {
                    const error = await response.json();
                    document.getElementById('product-profiles-table-body').innerHTML = 
                        '<tr><td colspan="7" class="no-data">加载商品画像失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('加载商品画像失败:', error);
                document.getElementById('product-profiles-table-body').innerHTML = 
                    '<tr><td colspan="7" class="no-data">加载商品画像失败: ' + error.message + '</td></tr>';
            }
        }

        // 显示商品画像数据
        function displaySellerProductProfiles(profiles) {
            const tbody = document.getElementById('product-profiles-table-body');
            
            if (profiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">暂无商品画像</td></tr>';
                return;
            }
            
            tbody.innerHTML = profiles.map(profile => `
                <tr>
                    <td>${profile.product.name}</td>
                    <td>${profile.popularityScore || 0}/100</td>
                    <td><span class="status-badge status-${profile.lifecycle?.stage || 'introduction'}">${getProductLifecycleStageText(profile.lifecycle?.stage || 'introduction')}</span></td>
                    <td>${profile.salesMetrics?.totalSold || 0}</td>
                    <td>${profile.salesMetrics?.avgMonthlySales?.toFixed(2) || 0}</td>
                    <td>${(profile.userBehavior?.conversionRate * 100 || 0).toFixed(2)}%</td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewSellerProductProfile('${profile.product._id}')"><i class="fas fa-chart-bar"></i> 详情</button>
                    </td>
                </tr>
            `).join('');
        }

        // 获取商品生命周期阶段文本
        function getProductLifecycleStageText(stage) {
            const stageMap = {
                'introduction': '引入期',
                'growth': '成长期',
                'maturity': '成熟期',
                'decline': '衰退期'
            };
            return stageMap[stage] || stage;
        }

        // 搜索商品画像
        async function searchProductProfiles() {
            const searchTerm = document.getElementById('seller-product-profile-search').value.toLowerCase();
            const token = localStorage.getItem('token');
            
            if (!searchTerm) {
                loadSellerProductProfiles();
                return;
            }
            
            try {
                const response = await fetch('/api/seller/product-profiles', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profiles = await response.json();
                    const filteredProfiles = profiles.filter(profile => 
                        profile.product.name.toLowerCase().includes(searchTerm) ||
                        (profile.product.category && profile.product.category.toLowerCase().includes(searchTerm))
                    );
                    displaySellerProductProfiles(filteredProfiles);
                } else {
                    const error = await response.json();
                    document.getElementById('product-profiles-table-body').innerHTML = 
                        '<tr><td colspan="7" class="no-data">搜索失败: ' + (error.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('搜索商品画像失败:', error);
                document.getElementById('product-profiles-table-body').innerHTML = 
                    '<tr><td colspan="7" class="no-data">搜索失败: ' + error.message + '</td></tr>';
            }
        }

        // 查看商品画像详情
        async function viewSellerProductProfile(productId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/seller/product-profiles/${productId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    showSellerProductProfileDetails(profile);
                } else {
                    const error = await response.json();
                    showNotification('加载商品画像详情失败: ' + (error.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('加载商品画像详情失败:', error);
                showNotification('加载商品画像详情失败: ' + error.message, 'error');
            }
        }

        // 显示商品画像详情
        function showSellerProductProfileDetails(profile) {
            const modal = document.getElementById('seller-product-profile-modal');
            const details = document.getElementById('seller-product-profile-details');
            
            details.innerHTML = `
                <div class="profile-details">
                    <div class="profile-card">
                        <h4><i class="fas fa-box"></i> 基本信息</h4>
                        <div class="profile-item">
                            <span class="profile-label">商品名称:</span>
                            <span class="profile-value">${profile.product.name}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">分类:</span>
                            <span class="profile-value">${profile.product.category || '未分类'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">价格:</span>
                            <span class="profile-value">¥${profile.product.price.toFixed(2)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">受欢迎度评分:</span>
                            <span class="profile-value">${profile.popularityScore || 0}/100</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">生命周期阶段:</span>
                            <span class="profile-value"><span class="status-badge status-${profile.lifecycle?.stage || 'introduction'}">${getProductLifecycleStageText(profile.lifecycle?.stage || 'introduction')}</span></span>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h4><i class="fas fa-chart-line"></i> 销售表现</h4>
                        <div class="profile-item">
                            <span class="profile-label">总销量:</span>
                            <span class="profile-value">${profile.salesMetrics?.totalSold || 0}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">平均月销量:</span>
                            <span class="profile-value">${profile.salesMetrics?.avgMonthlySales?.toFixed(2) || 0}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">销售趋势:</span>
                            <span class="profile-value">${profile.salesMetrics?.salesTrend || '未知'}</span>
                        </div>
                    </div>
                    
                    <div class="profile-card">
                        <h4><i class="fas fa-users"></i> 用户行为</h4>
                        <div class="profile-item">
                            <span class="profile-label">浏览次数:</span>
                            <span class="profile-value">${profile.userBehavior?.viewCount || 0}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">加购次数:</span>
                            <span class="profile-value">${profile.userBehavior?.addToCartCount || 0}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">购买次数:</span>
                            <span class="profile-value">${profile.userBehavior?.purchaseCount || 0}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">转化率:</span>
                            <span class="profile-value">${(profile.userBehavior?.conversionRate * 100 || 0).toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // 添加商品表单提交
        document.getElementById('product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                quantity: parseInt(document.getElementById('product-quantity').value),
                category: document.getElementById('product-category').value,
                imageUrl: document.getElementById('product-image').value
            };
            
            // 验证必填字段
            if (!productData.name || !productData.description || !productData.price || !productData.quantity || !productData.category) {
                showNotification('请填写所有必填字段', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    showNotification('商品添加成功', 'success');
                    switchTab('products');
                    loadProducts();
                    loadDashboard();
                } else {
                    const errorData = await response.json();
                    showNotification('添加失败: ' + (errorData.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('添加商品失败:', error);
                showNotification('添加商品失败: ' + error.message, 'error');
            }
        });

        // 编辑商品表单提交
        document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const productId = document.getElementById('edit-product-id').value;
            const productData = {
                name: document.getElementById('edit-product-name').value,
                description: document.getElementById('edit-product-description').value,
                price: parseFloat(document.getElementById('edit-product-price').value),
                quantity: parseInt(document.getElementById('edit-product-quantity').value),
                category: document.getElementById('edit-product-category').value,
                imageUrl: document.getElementById('edit-product-image').value
            };
            
            // 验证必填字段
            if (!productData.name || !productData.description || !productData.price || !productData.quantity || !productData.category) {
                showNotification('请填写所有必填字段', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });
                
                if (response.ok) {
                    showNotification('商品更新成功', 'success');
                    document.getElementById('product-modal').style.display = 'none';
                    loadProducts();
                    loadDashboard();
                } else {
                    const errorData = await response.json();
                    showNotification('更新失败: ' + (errorData.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('更新商品失败:', error);
                showNotification('更新商品失败: ' + error.message, 'error');
            }
        });

        // 检查用户状态
        async function checkUserStatus() {
            const token = localStorage.getItem('token');
            const userActions = document.getElementById('user-actions');
            
            if (token) {
                try {
                    const response = await fetch('/api/users/profile', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const user = await response.json();
                        userActions.innerHTML = `
                            <span><i class="fas fa-user"></i> ${user.username}</span>
                            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出</a>
                            ${user.role === 'admin' ? '<a href="/admin"><i class="fas fa-cog"></i> 管理后台</a>' : ''}
                            <a href="/user-center"><i class="fas fa-user-circle"></i> 用户中心</a>
                        `;
                    }
                } catch (error) {
                    console.error('检查用户状态失败:', error);
                }
            }
        }
    </script>
</body>
</html>